package com.yunke.amazon.advertisingView.service.impl;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.springframework.stereotype.Service;

import com.yunke.amazon.advertisingView.dao.AdvertisingViewMapper;
import com.yunke.amazon.advertisingView.entity.ShopAdDataOverviewImageResult;
import com.yunke.amazon.advertisingView.service.AdvertisingViewService;
import com.yunke.amazon.bind.dao.SubAccountDAO;
import com.yunke.amazon.client.util.NoteResult;
import com.yunke.amazon.util.StringToDate;
import com.yunke.amazon.util.SubPri;

@Service
public class AdvertisingViewServiceImpl implements AdvertisingViewService{

	@Resource
	private AdvertisingViewMapper advertisingViewMapper;
	@Resource
	private SubAccountDAO subAccountDAO;
	
	@Override
	public ShopAdDataOverviewImageResult shopAdDataOverviewImage(String user_id, String shop_id, String sale_channel,
			String startDate, String endDate, String shopAdDataOverviewType) {
		// TODO Auto-generated method stub
		
		ShopAdDataOverviewImageResult shopAdDataOverviewImageResult = new ShopAdDataOverviewImageResult();
		Map<Object, Object> map = new HashMap<>();
		SimpleDateFormat sdf = new SimpleDateFormat("yy-MM-dd");
		SimpleDateFormat sdf2 = new SimpleDateFormat("MM-dd");
		Date start = StringToDate.changeStringToDate(startDate);
		Date end = StringToDate.changeStringToDate(endDate);
		
//		Date end =new Date();
//		try {
//			end = sdf.parse(endDate);
//		} catch (ParseException e) {
//			e.printStackTrace();
//		}
		
		Calendar calendar = new GregorianCalendar();
		calendar.setTime(end);
		calendar.add(calendar.DATE, 1);
		end = calendar.getTime(); 
		String format2 = sdf.format(end);
		end= StringToDate.changeStringToDate(format2);
		map.put("start", start);
		map.put("end", end);
		SubPri subPri = SubPri.getSubPri(Integer.parseInt(user_id), subAccountDAO);
		if(subPri.getUserType()==1){
			map.put("userId", user_id);
			map.put("loginUserId", user_id);
			map.put("userType", "PriAccount");
		}else if(subPri.getUserType()==0){
			map.put("userId",subPri.getPriAccount() );
			map.put("loginUserId", user_id);
			map.put("userType", "SubAccount");
		}
		map.put("shopId", shop_id);
		map.put("saleChannel", sale_channel);
		map.put("shopAdDataOverviewType",shopAdDataOverviewType);
		
		
		List<Map<String, String>> profitByDesigners = advertisingViewMapper.shopAdDataOverviewImage(map);
//		System.out.println("进入Impl调用存储过程");
		
		List<String> listDateX = new ArrayList<>();
		List<Integer> listExposureY = new ArrayList<>();
		List<Integer> listyClickY = new ArrayList<>();
		List<Double> listyOrderY = new ArrayList<>();
		
		Integer totalImpressions = 0; 
		Integer totalClicks = 0; 
		Integer totalOrders = 0; 
		
		for(Map<?, ?> o :profitByDesigners){
			listDateX.add((String) o.get("snapshotDate"));
			listExposureY.add(Integer.parseInt(o.get("impressions").toString()));		
			listyClickY.add(Integer.parseInt(o.get("clicks").toString()));
			listyOrderY.add(Double.parseDouble(o.get("orders").toString())*100/100);
			
			totalImpressions += Integer.parseInt(o.get("impressions").toString());
			totalClicks += Integer.parseInt(o.get("clicks").toString());
			totalOrders += (int) Double.parseDouble(o.get("orders").toString())*100/100;
		}
//		System.out.println("totalImpressions = "+totalImpressions);
//		System.out.println("totalClicks = "+totalClicks);
//		System.out.println("totalOrders = "+totalOrders);
		
	
		shopAdDataOverviewImageResult.setX(listDateX);
		shopAdDataOverviewImageResult.setY1(listExposureY);
		shopAdDataOverviewImageResult.setY2(listyClickY);
		shopAdDataOverviewImageResult.setY3(listyOrderY);
		
		shopAdDataOverviewImageResult.setExposureTotal(totalImpressions);
		shopAdDataOverviewImageResult.setClickTotal(totalClicks);
		shopAdDataOverviewImageResult.setOrderTotal(totalOrders);
		
		return shopAdDataOverviewImageResult;
		
	}

	@Override
	public NoteResult shopAdReport(String userId, String shopId, String saleChannel, String startDate, String endDate,
			String shopAdDataOverviewType, String firstDimension, String secondDimension, String conditionalFilterKey,
			String conditionalFilterRelationship, String conditionalFilterValue, String currentPage, String pageSize,
			String sortVariable, String sortType) {
		// TODO Auto-generated method stub
		
		
		switch (firstDimension) {
		case "campaigns":
			firstDimension = "campaign_id";
			break;
		case "adgroups":
			firstDimension = "ad_group_id";
			break;
		case "productads":
			firstDimension = "ad_id";
			break;
		case "keywords":
			firstDimension = "keyword_id";
			break;
		case "SKU":
			firstDimension = "sku";
			break;

		default:
			break;
		}
		switch (secondDimension) {
		case "blank":
			secondDimension = null;
			break;
		case "campaigns":
			secondDimension = "campaign_id";
			break;
		case "adgroups":
			secondDimension = "ad_group_id";
			break;
		case "productads":
			secondDimension = "ad_id";
			break;
		case "keywords":
			secondDimension = "keyword_id";
			break;
		case "SKU":
			secondDimension = "sku";
			break;
			
		default:
			break;
		}
		switch (conditionalFilterKey) {
		case "campaigns":
			conditionalFilterKey = "campaign_name";
			break;
		case "adgroups":
			conditionalFilterKey = "ad_group_name";
			break;
		case "ASIN":
			conditionalFilterKey = "asin";
			break;
		case "keywords":
			conditionalFilterKey = "keywordText";
			break;
		case "SKU":
			conditionalFilterKey = "sku";
			break;
		default:
			break;
		}
		
		switch (conditionalFilterRelationship) {
		case "equal":
			conditionalFilterRelationship = " = " + "'"+conditionalFilterValue+"' ";
			break;
		case "contain":
			conditionalFilterRelationship = " LIKE "+"'%"+conditionalFilterValue+"%' ";
			break;
		default:
			break;
		}
		
		System.out.println("firstDimension = "+firstDimension);
		System.out.println("secondDimension = "+secondDimension);
		NoteResult noteResult = new NoteResult();
		Map<Object, Object> map = new HashMap<>();
		SimpleDateFormat sdf = new SimpleDateFormat("yy-MM-dd");
//		SimpleDateFormat sdf2 = new SimpleDateFormat("MM-dd");
		Date start = StringToDate.changeStringToDate(startDate);
		Date end = StringToDate.changeStringToDate(endDate);
		
		Calendar calendar = new GregorianCalendar();
		calendar.setTime(end);
		calendar.add(calendar.DATE, 1);
		end = calendar.getTime(); 
		String format2 = sdf.format(end);
		end= StringToDate.changeStringToDate(format2);
		map.put("startDate", start);
		map.put("endDate", end);
		SubPri subPri = SubPri.getSubPri(Integer.parseInt(userId), subAccountDAO);
		if(subPri.getUserType()==1){
			map.put("userId", userId);
			map.put("loginUserId", userId);
			map.put("userType", "PriAccount");
		}else if(subPri.getUserType()==0){
			map.put("userId",subPri.getPriAccount() );
			map.put("loginUserId", userId);
			map.put("userType", "SubAccount");
		}
		map.put("shopId", shopId);
		map.put("saleChannel", saleChannel);
		map.put("firstDimension",firstDimension);
		map.put("secondDimension",secondDimension);
		map.put("conditionalFilterKey",conditionalFilterKey);
		map.put("conditionalFilterRelationship",conditionalFilterRelationship);
		map.put("conditionalFilterValue",conditionalFilterValue);
		System.out.println("currentPage = "+currentPage);
		int currentPageStr = (Integer.parseInt(currentPage)-1)*Integer.parseInt(pageSize);
		int pageSizeStr = Integer.parseInt(pageSize);
		map.put("currentPage",(Integer.parseInt(currentPage)-1)*Integer.parseInt(pageSize)+"");
		map.put("pageSize",Integer.parseInt(pageSize)+"");
		map.put("sortVariable",sortVariable);
		map.put("sortType",sortType);
		String selectWhere = "";
		String selectGroupby = firstDimension +"," + secondDimension;
		if("blank".equals(conditionalFilterValue)){
			selectWhere = " productads_report.`shop_id` = "+ shopId + " AND productads_report.`sale_channel` = '" + saleChannel + "'";
		}else if(! "blank".equals(conditionalFilterValue)){
			selectWhere = " productads_report.`shop_id` = "+ shopId + " AND "+conditionalFilterKey+" "+conditionalFilterRelationship+" "+ " AND productads_report.`sale_channel` = '" + saleChannel + "'";
		}else{
			selectWhere = " productads_report.`shop_id` = "+ shopId + " AND productads_report.`sale_channel` = '" + saleChannel + "'";
			
		}
		
		String selectElement = "productads_report.`shop_id`,productads_report.`sale_channel`,"
				+ "productads_report.`campaign_id`,productads_report.`campaign_name`,productads_report.`ad_group_id`,"
				+ "productads_report.`ad_group_name`,productads_report.`campaign_type`,productads_report.`currency`,"
				+ "productads_report.`segment`,productads_report.`ad_id`,productads_report.`sku`,productads_report.`asin`,"
				+ "IF(SUM(productads_report.`impressions`) IS NULL,0,SUM(productads_report.`impressions`)) impressions,"
				+ "IF(SUM(productads_report.`clicks`) IS NULL,0,SUM(productads_report.`clicks`)) clicks,"
				+ "IF(SUM(productads_report.`cost`) IS NULL,0,SUM(productads_report.`cost`)) cost,"
				+ "IF(SUM(productads_report.`attributed_sales7d`) IS NULL,0,SUM(productads_report.`attributed_sales7d`)) attributed_sales7d,"
				+ "IF(SUM(productads_report.`attributed_units_ordered7d`) IS NULL,0,SUM(productads_report.`attributed_units_ordered7d`)) attributed_units_ordered7d,"
				+ "IF(SUM(productads_report.`attributed_conversions7d`) IS NULL,0,SUM(productads_report.`attributed_conversions7d`)) attributed_conversions7d,"
				+ "IF(SUM(productads_report.`attributed_sales7d_sameSKU`) IS NULL,0,SUM(productads_report.`attributed_sales7d_sameSKU`)) attributed_sales7d_sameSKU,"
				+ "IF(SUM(productads_report.`attributed_conversions7d_sameSKU`) IS NULL,0,SUM(productads_report.`attributed_conversions7d_sameSKU`)) attributed_conversions7d_sameSKU";
		
		String limitStr = currentPageStr +"," + pageSizeStr;
		map.put("limitStr",limitStr);
		map.put("selectGroupby",selectGroupby);
		map.put("selectElement",selectElement);
		map.put("selectWhere",selectWhere);
		String SQLStr = "select * from productads_report";
		map.put("SQLStr",SQLStr);
		
		if("keywords".equals(firstDimension) && "SKU".equals(secondDimension)){
			System.out.println("需要查询asins表，并且强制添加过滤条件：转化状态=‘购买’");
		}else if(("keywords".equals(firstDimension) || "keywords".equals(secondDimension)) && (! "SKU".equals(firstDimension) || ! "SKU".equals(secondDimension))){
			System.out.println("需要查询关键词表");
			
			
		}else{
			System.out.println("查询广告数据表");
			

			try {
				
			} catch (Exception e) {
				// TODO: handle exception
			}
			
			List<List<Map<String, String>>> adQueryProductsAdsReport = advertisingViewMapper.adQueryProductsAdsReport(map);
			System.out.println("adQueryProductsAdsReport"+adQueryProductsAdsReport.toString());
			
			if(adQueryProductsAdsReport.size()!=0){
				
				List<Map<String, String>> AdTableDate = adQueryProductsAdsReport.get(0);
				List<Map<String, String>> AdTotalCount = adQueryProductsAdsReport.get(1);
				
				noteResult.setStatus(1);
				noteResult.setTotalCount(AdTotalCount.size());
				noteResult.setPageCount((AdTotalCount.size() + Integer.parseInt(pageSize) -1)/Integer.parseInt(pageSize));
				noteResult.setData(AdTableDate);
			}
			
			
			
		}
		
		
		
		
		
		
		return noteResult;
	}
	

}
